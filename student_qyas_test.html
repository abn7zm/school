<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>الاختبارات</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:Tahoma,Arial;
  margin:0;
  background:#f4f6f8;
  direction:rtl
}
header{
  background:#005d7e;
  color:#fff;
  padding:15px;
  text-align:center
}

/* cards */
.cards{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
  gap:20px;
  padding:20px
}
.test-card{
  border-radius:12px;
  overflow:hidden;
  box-shadow:0 6px 15px rgba(0,0,0,.1);
  background:#fff;
  transition:.3s;
  position:relative;
}
.test-card:hover{
  transform:translateY(-5px)
}
.card-top{
  background:#005d7e;
  color:#fff;
  height:120px;
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
  font-size:18px;
  font-weight:bold;
  padding:10px;
  cursor:pointer
}
.card-bottom{
  display:flex;
  justify-content:space-between;
  padding:12px 15px;
  align-items:center
}
.type{
  font-weight:bold
}
.level{
  padding:5px 12px;
  border-radius:20px;
  color:#fff;
  font-size:13px
}
.easy{background:green}
.medium{background:orange}
.hard{background:red}

/* last score */
.last-score{
  padding:5px 15px;
  font-size:14px;
  color:#333;
}

/* spinner */
.spinner-container{
  text-align:center;
  padding:40px
}
.spinner{
  width:40px;
  height:40px;
  border:4px solid #ddd;
  border-top:4px solid #005d7e;
  border-radius:50%;
  animation:spin 1s linear infinite;
  margin:0 auto 10px
}

/* score modal */
#scoreModal{
  display:none;
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.5);
  z-index:9999;
  justify-content:center;
  align-items:center;
}
#scoreBox{
  background:#fff;
  padding:20px;
  border-radius:10px;
  max-width:300px;
  width:90%;
  text-align:center;
}
#scoreBox input, #scoreBox select{
  width:100%;
  padding:8px;
  margin-top:10px;
}
#scoreBox button{
  margin-top:10px;
  width:100%;
  padding:8px;
  background:#28a745;
  color:#fff;
  border:none;
  border-radius:6px;
  cursor:pointer
}
</style>
</head>

<body>

<header>
  <h2>الاختبارات المتاحة</h2>
</header>

<div id="loading" class="spinner-container">
  <div class="spinner"></div>
  <p>جاري تحميل الاختبارات...</p>
</div>

<div id="cardsContainer" class="cards"></div>

<!-- Score Modal -->
<div id="scoreModal">
  <div id="scoreBox">
    <h3>أدخل درجتك للاختبار</h3>
   <input type="number" min="0" id="scoreInput" placeholder="الدرجة التي حصلت عليها">
<p id="scoreMaxText" style="margin-top:10px;">من أصل 0</p>

    <button id="saveScoreBtn">حفظ الدرجة</button>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxw2vzEv0X1A9reYmnlm5hJzqPUHAs-swEefQTerhLYNyHICztUwv24GG_hwUBOdaQ_rA/exec"; // ضع رابط Google Apps Script هنا
const studentName = localStorage.getItem("userName") || "غير معروف";
let currentTestTitle = null;
let currentCard = null;

// --- تعيين لون الصعوبة ---
function levelClass(l){
  if(l==="سهل") return "easy";
  if(l==="متوسط") return "medium";
  return "hard";
}

// --- تحميل الاختبارات ---
function loadTests(){
  loading.style.display="block";
  cardsContainer.innerHTML="";

  fetch(API_URL)
    .then(r=>r.json())
    .then(data=>{
      loading.style.display="none";

      if(data.length===0){
        cardsContainer.innerHTML="<p style='text-align:center'>لا توجد اختبارات حالياً</p>";
        return;
      }

      data.forEach(t=>{
        const card = document.createElement("div");
        card.className="test-card";
        card.innerHTML=`
          <div class="card-top">${t.title}</div>
          <div class="card-bottom">
            <div class="type">${t.type}</div>
            <div class="level ${levelClass(t.level)}">${t.level}</div>
          </div>
          <div class="last-score" id="lastScore_${t.title.replace(/\s+/g,'_')}">
            آخر درجة: - 
          </div>
        `;

        // عند الضغط على البطاقة
       // عند الضغط على البطاقة
card.querySelector(".card-top").addEventListener("click", ()=>{
  currentTestTitle = t.title;
  currentCard = card;
  currentTestMaxScore = t.maxScore; // <-- خزننا الدرجة القصوى
  window.open(t.link,"_blank");
  showScoreModal();
});


        cardsContainer.appendChild(card);
      });

      // بعد تحميل البطاقات، نجلب آخر درجات الطالب من الشيت
      showLastScores();
    })
    .catch(()=>{loading.innerHTML="❌ فشل تحميل البيانات";});
}

// --- مودال إدخال الدرجة ---
function showScoreModal(){
  document.getElementById("scoreMaxText").innerText = "من أصل " + currentTestMaxScore;
  document.getElementById("scoreModal").style.display="flex";
}

function hideScoreModal(){document.getElementById("scoreModal").style.display="none";}

// حفظ الدرجة
document.getElementById("saveScoreBtn").addEventListener("click", ()=>{
  const scoreInput = document.getElementById("scoreInput");
  const score = Number(scoreInput.value); // الدرجة التي أدخلها الطالب

  // تحقق من صحة الدرجة مقابل الدرجة القصوى
  if(score === "" || score < 0 || score > currentTestMaxScore){
    alert(`يرجى إدخال درجة صحيحة من 0 إلى ${currentTestMaxScore}`);
    return;
  }

  const fd = new FormData();
  fd.append("action","saveScore");
  fd.append("student", studentName);
  fd.append("test", currentTestTitle);
  fd.append("score", score + " من " + currentTestMaxScore);

  fetch(API_URL,{method:"POST",body:fd})
    .then(()=>{
      alert("✅ تم حفظ درجتك");
      scoreInput.value="";
      hideScoreModal();
      updateLastScore(currentTestTitle, score + " من " + currentTestMaxScore);
    });
});

// --- جلب آخر درجات الطالب عند تحميل الصفحة ---
function showLastScores(){
  fetch(API_URL + "?action=getScores")
    .then(r=>r.json())
    .then(scores=>{
      scores.forEach(s=>{
        if(s.student === studentName){
          const id = "lastScore_" + s.test.replace(/\s+/g,'_');
          const el = document.getElementById(id);
          if(el) el.innerText = "آخر درجة: " + s.score;
        }
      });
    });
}

// --- تحديث آخر درجة تحت البطاقة ---
function updateLastScore(testTitle, scoreText){
  const id = "lastScore_" + testTitle.replace(/\s+/g,'_');
  const el = document.getElementById(id);
  if(el) el.innerText = "آخر درجة: " + scoreText;
}

// بدء تحميل الاختبارات
loadTests();
</script>

</body>
</html>
