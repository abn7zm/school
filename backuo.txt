const sheets = SpreadsheetApp.openByUrl("https://docs.google.com/spreadsheets/d/1-IAOaZT6c75rKXqoPGgBTlTjt_SpcgfOXMWowSnx20o/edit?gid=0");

function doPost(e) {
  Logger.log(e);  // لتسجيل جميع البيانات الواردة

  const sheet = sheets.getSheetByName("data");
  
  if (!sheet) {
    Logger.log("لم يتم العثور على ورقة البيانات 'data'");
    return ContentService.createTextOutput("Sheet not found");
  }
  
  if (e && e.parameter) {
    let data = e.parameter;
    Logger.log(data);  // لتسجيل البيانات التي تم استلامها
    
    // التحقق مما إذا كانت البيانات هي للتسجيل أو لتسجيل الدخول
    if (data.name) {
      // إنشاء حساب جديد
      sheet.appendRow([
          data.name || "no name",   // A
  data.id || "no id",       // B
  data.email || "no email", // C
  data.pass || "no pass",   // D
  data.phone || "no phone"  // E
      ]);
      
      return ContentService.createTextOutput("Success");
    
    } else if (data.idNumber && data.password) {
      // تسجيل الدخول
      var idNumber = data.idNumber;
      var password = data.password;
      var sheetData = sheet.getRange("A:E").getValues(); // A=اسم, B=رقم, C=إيميل, D=باسوورد

      for (var i = 0; i < sheetData.length; i++) {
        var name = sheetData[i][0];
        var id = sheetData[i][1];
        var email = sheetData[i][2];
        var pass = sheetData[i][3];
        var phone = sheetData[i][4];

        if (id == idNumber) {
          if (pass == password) {
            // هنا نرجع JSON مع الاسم ورقم الهوية
            return ContentService.createTextOutput(JSON.stringify({name: name, id: id, email: email, phone: phone}));
          } else {
            return ContentService.createTextOutput("incorrect_password");
          }
        }
      }

      return ContentService.createTextOutput("incorrect_id");
    }
  } else {
    Logger.log("لم يتم تلقي أي بيانات");
    return ContentService.createTextOutput("No data received or incorrect format");
  }
}

function listSheets() {
  const sheetNames = sheets.getSheets().map(sheet => sheet.getName());
  Logger.log("الأوراق الموجودة في جدول البيانات: " + sheetNames.join(", "));
}

function testSheet() {
  const sheet = sheets.getSheetByName("data");
  
  if (!sheet) {
    Logger.log("لم يتم العثور على ورقة البيانات 'data'");
  } else {
    Logger.log("تم العثور على ورقة البيانات 'data'");
  }
}

function doGet() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheets()[0];
  const data = sheet.getDataRange().getValues();
  const json = data.slice(1).map(row => ({
    name: row[0],
    id: row[1],
    email: row[2],
    phone: row[4]
  }));
  
  return ContentService.createTextOutput(JSON.stringify(json))
    .setMimeType(ContentService.MimeType.JSON);
}
