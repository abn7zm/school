<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>ترتيب الطلاب</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:Tahoma,Arial;
  margin:0;
  background:#f4f6f8;
  direction:rtl
}
header{
  background:#005d7e;
  color:#fff;
  padding:15px;
  text-align:center
}

/* cards */
.cards{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
  gap:20px;
  padding:20px
}
.test-card{
  border-radius:12px;
  overflow:hidden;
  box-shadow:0 6px 15px rgba(0,0,0,.1);
  background:#fff;
  transition:.3s
}
.test-card:hover{
  transform:translateY(-5px)
}
.card-top{
  background:#005d7e;
  color:#fff;
  height:120px;
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
  font-size:18px;
  font-weight:bold;
  padding:10px;
  cursor:pointer
}
.card-bottom{
  display:flex;
  justify-content:flex-end;
  padding:12px 15px;
  align-items:center
}
.type{font-weight:bold}

/* top 5 list */
.top-list{
  padding:10px 15px;
  border-top:1px solid #eee;
  background:#f9f9f9;
}
.top-list h4{
  margin:0 0 5px 0;
  font-size:14px;
  color:#333;
}
.top-list ul{
  list-style:none;
  padding:0;
  margin:0;
}
.top-list li{
  padding:3px 0;
  font-size:13px;
}

/* ألوان المراتب */
.rank-1{color:#FFD700;font-weight:bold;} /* ذهبي */
.rank-2{color:#C0C0C0;font-weight:bold;} /* فضي */
.rank-3{color:#CD7F32;font-weight:bold;} /* برونزي */

/* spinner */
.spinner-container{
  text-align:center;
  padding:40px
}
.spinner{
  width:40px;
  height:40px;
  border:4px solid #ddd;
  border-top:4px solid #005d7e;
  border-radius:50%;
  animation:spin 1s linear infinite;
  margin:0 auto 10px
}
@keyframes spin{
  to{transform:rotate(360deg)}
}
</style>
</head>

<body>

<header>
  <h2>ترتيب أعلى الطلاب</h2>
</header>

<div id="loading" class="spinner-container">
  <div class="spinner"></div>
  <p>جاري تحميل البيانات...</p>
</div>

<div id="cardsContainer" class="cards"></div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxw2vzEv0X1A9reYmnlm5hJzqPUHAs-swEefQTerhLYNyHICztUwv24GG_hwUBOdaQ_rA/exec"; // رابط Google Script الحالي

function loadRanking(){
  const loading = document.getElementById("loading");
  const cardsContainer = document.getElementById("cardsContainer");
  loading.style.display = "block";
  cardsContainer.innerHTML = "";

  fetch(API_URL)
    .then(r=>r.json())
    .then(tests=>{
      fetch(API_URL+"?action=getScores")
        .then(r=>r.json())
        .then(scores=>{
          loading.style.display = "none";

          if(tests.length === 0){
            cardsContainer.innerHTML="<p style='text-align:center'>لا توجد اختبارات</p>";
            return;
          }

          tests.forEach(test=>{
            const card = document.createElement("div");
            card.className = "test-card";
            card.innerHTML = `
              <div class="card-top">${test.title}</div>
              <div class="card-bottom">
                <div class="type">${test.type}</div>
              </div>
              <div class="top-list">
                <h4>أعلى 5 طلاب:</h4>
                <ul id="topList_${test.title.replace(/\s+/g,'_')}">
                  <li>جاري التحميل...</li>
                </ul>
              </div>
            `;
            cardsContainer.appendChild(card);

            // معالجة الدرجات لكل اختبار
            const testScores = scores
              .filter(s=>s.test===test.title)
              .map(s=>{
                const parts = s.score.split(" من ");
                const scoreNum = parseFloat(parts[0]) || 0;
                return {student: s.student, score: scoreNum};
              });

            // أعلى درجة لكل طالب فقط
            const highestPerStudent = {};
            testScores.forEach(s=>{
              if(!highestPerStudent[s.student] || s.score > highestPerStudent[s.student]){
                highestPerStudent[s.student] = s.score;
              }
            });

            const sorted = Object.entries(highestPerStudent)
              .map(([student, score])=>({student, score}))
              .sort((a,b)=>b.score - a.score)
              .slice(0,5);

            const ul = document.getElementById("topList_"+test.title.replace(/\s+/g,'_'));
            ul.innerHTML = "";
            if(sorted.length===0){
              ul.innerHTML="<li>لا توجد درجات</li>";
            } else {
              sorted.forEach((s,i)=>{
                let rankClass = "";
                if(i===0) rankClass="rank-1";
                else if(i===1) rankClass="rank-2";
                else if(i===2) rankClass="rank-3";
                ul.innerHTML += `<li class="${rankClass}">${i+1}. ${s.student} - ${s.score}</li>`;
              });
            }
          });
        });
    })
    .catch(()=>{
      document.getElementById("loading").innerHTML="❌ فشل تحميل البيانات";
    });
}

loadRanking();
</script>

</body>
</html>
